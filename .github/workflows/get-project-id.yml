name: Fetch Projects

on: [push]

jobs:
  find_project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Fetch Last Updated Project
        id: find_project
        env:
          GH_TOKEN: ${{ secrets.ORG_GH_TOKEN }}  # Use your organization secret
          TEAM: "s24-4pm-1"  # Specify your team name or adjust as needed
          ORG_NAME: "brownfield-team"  # Replace with your GitHub organization name
        run: |
          # Set the GitHub API URL for fetching projects
          API_URL="https://api.github.com/orgs/${ORG_NAME}/projects"

          # Fetch projects using the token without needing the GitHub CLI
          PROJECTS_JSON=$(curl -s -H "Authorization: token ${GH_TOKEN}" "${API_URL}")

          echo "Projects JSON Output: $PROJECTS_JSON"

          if [ $? -ne 0 ]; then
            echo "Failed to fetch projects"
            exit 1
          fi

          # Now use jq to find the project ID
          PROJECT_ID=$(echo "$PROJECTS_JSON" | jq -r ".[] | select(.name | endswith(\"${TEAM}\")) | .id" | head -n 1)

          if [ -z "$PROJECT_ID" ]; then
            echo "No project found for team $TEAM."
            exit 1
          fi

          echo "Found Project ID: $PROJECT_ID"
          echo "project_id=$PROJECT_ID" >> $GITHUB_ENV  # Set output in the new way
