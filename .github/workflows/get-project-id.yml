name: Fetch Last Updated Project

on: 
  push:
  workflow_dispatch:

jobs:
  find_project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Fetch Last Updated Project
        id: find_project
        env:
          GH_TOKEN: ${{ github.token }}  # Use the automatically provided GitHub token
          TEAM_TO_CHANNEL: "{ \"s24-4pm-1\": \"C071HLX6DMK\", \"s24-4pm-2\": \"C06592UPS91\" }"
          TEAM: ${{ github.repository }}  # Repository name (e.g., owner/repo)
          ORG_NAME: "brownfield-team"  # Replace with your GitHub organization name
        run: |
          # Set the GitHub API URL for fetching projects
          API_URL="https://api.github.com/orgs/${ORG_NAME}/projects"

          # Use curl to fetch projects with authorization
          PROJECTS_JSON=$(curl -s -H "Authorization: token ${GH_TOKEN}" "${API_URL}")

          if [ $? -ne 0 ]; then
            echo "Failed to fetch projects"
            exit 1
          fi

          echo "Projects JSON Output: $PROJECTS_JSON"

          # Now use jq to find the project ID
          PROJECT_ID=$(echo "$PROJECTS_JSON" | jq -r ".[] | select(.name | endswith(\"${TEAM}\")) | .id" | head -n 1)

          if [ -z "$PROJECT_ID" ]; then
            echo "No project found for team $TEAM."
            exit 1
          fi

          echo "Found Project ID: $PROJECT_ID"
          echo "project_id=$PROJECT_ID" >> $GITHUB_ENV  # Set output in the new way
