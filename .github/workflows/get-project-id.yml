name: Kanban Slack Update

on:
  push:
    branches:
      - main  # Adjust the branch name as needed
  workflow_dispatch:  # Allows manual triggering

env:
  PAT: ${{ secrets.PAT }}
  TEAM_TO_CHANNEL: "{ \"s24-4pm-1\": \"C071HLX6DMK\", \"s24-4pm-2\": \"C06592UPS91\" }"
  TEAM: ${{ github.repository }}
  ORG_NAME: "brownfield-team"  # Replace with your GitHub organization name

jobs:
  get-team-name:
    name: Get Team Name
    runs-on: ubuntu-latest
    outputs:
      team: ${{ steps.find_team.outputs.team }}
    steps:
      - name: Extract Team Name from Repo
        id: find_team
        run: |
          REPO=${{ github.repository }}
          TEAM_NAME="${REPO: -9}"
          echo "::set-output name=team::${TEAM_NAME}"

  get-project-id:
    name: Find Last Updated Project ID for Team
    runs-on: ubuntu-latest
    needs: get-team-name
    outputs:
      project_id: ${{ steps.find_project.outputs.project_id }}
    steps:
      - name: Fetch Project ID
        id: find_project
        shell: pwsh
        run: |
          $query = '{organization(login:"${{ env.ORG_NAME }}"){projectsV2(first:100){nodes{id,title,updatedAt}}}}'
          $headers = @{
              Authorization = "Bearer ${{ secrets.PAT }}"
              "Content-Type" = "application/json"
          }
          $body = @{ query = $query } | ConvertTo-Json
          $response = Invoke-WebRequest -Uri "https://api.github.com/graphql" -Method Post -Headers $headers -Body $body
          Write-Host "Projects JSON Output: $($response.Content)"
          
          $projectID = ($response.Content | ConvertFrom-Json).data.organization.projectsV2.nodes | Where-Object { $_.title -like "*${{ needs.get-team-name.outputs.team }}*" } | Select-Object -First 1 -ExpandProperty id
          
          if (-not $projectID) {
              Write-Host "No project found for team ${{ needs.get-team-name.outputs.team }}."
              exit 1
          }
          
          Write-Host "Found Project ID: $projectID"
          echo "::set-output name=project_id::$projectID"

  get-project-data:
    name: Output GraphQL Query Result
    runs-on: ubuntu-latest
    needs: get-project-id
    outputs:
      project_data: ${{ steps.output_query.outputs.project_data }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Output GraphQL Query Result
        id: output_query
        shell: pwsh
        env:
          project_id: ${{ needs.get-project-id.outputs.project_id }}
          PAT: ${{ secrets.PAT }}
        run: |
          $PROJECT_ID = $env:project_id; $TOKEN = $env:PAT; $query = "{ node(id: `"$PROJECT_ID`") { ... on ProjectV2 { items(first: 100) { nodes { id fieldValues(first: 100) { nodes { ... on ProjectV2ItemFieldSingleSelectValue { field { ... on ProjectV2Field { name } } name } ... on ProjectV2ItemFieldTextValue { field { ... on ProjectV2Field { name } } text } } } content { ... on Issue { title assignees(first: 10) { nodes { login } } } ... on PullRequest { title assignees(first: 10) { nodes { login } } } } } } } } } }"; $headers = @{ Authorization = "Bearer $TOKEN"; "Content-Type" = "application/json" }; $body = @{ query = $query } | ConvertTo-Json; $response = Invoke-WebRequest -Uri "https://api.github.com/graphql" -Method Post -Headers $headers -Body $body; Write-Host $response.Content; echo "::set-output name=project_data::$($response.Content)"

  count_issues:
    name: Count Issues by Column and Assignee
    runs-on: ubuntu-latest
    needs: get-project-data
    outputs:
      issue_counts: ${{ steps.count_issues.outputs.issue_counts }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Count Issues by Column and Assignee
        id: count_issues
        shell: pwsh
        env:
          project_data: ${{ needs.get-project-data.outputs.project_data }}
        run: |
          Write-Host "Starting issue count process"
          $data = $env:project_data | ConvertFrom-Json
          Write-Host "Project Data JSON: $($data | ConvertTo-Json -Depth 10)"
          $issueCounts = @{}
          foreach ($item in $data.data.node.items.nodes) {
            Write-Host "Processing item: $($item.id)"
            $columnField = $item.fieldValues.nodes | Where-Object { $_.name -eq "Status" -or $_.name -eq "testing" -or $_.name -eq "Done" -or $_.name -eq "In Progress" -or $_.name -eq "Todo" }
            if ($null -ne $columnField) {
              Write-Host "Found column field: $($columnField | ConvertTo-Json -Depth 10)"
              $column = $columnField.name
              Write-Host "Processing column: $column"
              if ($null -ne $column) {
                $assignees = $item.content.assignees.nodes | Select-Object -ExpandProperty login
                foreach ($assignee in $assignees) {
                  Write-Host "Processing assignee: $assignee"
                  if (-not $issueCounts.ContainsKey($column)) {
                    $issueCounts[$column] = @{}
                  }
                  if (-not $issueCounts[$column].ContainsKey($assignee)) {
                    $issueCounts[$column][$assignee] = 0
                  }
                  $issueCounts[$column][$assignee]++
                }
              }
            } else {
              Write-Host "No column field found for item: $($item.id)"
            }
          }
          foreach ($column in $issueCounts.Keys) {
            Write-Host "Column: $column"
            foreach ($assignee in $issueCounts[$column].Keys) {
              Write-Host "  Assignee: $assignee, Count: $($issueCounts[$column][$assignee])"
            }
          }
          $issueCountsJson = $issueCounts | ConvertTo-Json -Depth 10
          echo "::set-output name=issue_counts::$issueCountsJson"
          Write-Host "Issue count process completed"

  generate-ascii-table:
    name: Generate ASCII Table
    runs-on: ubuntu-latest
    needs: count_issues
    steps:
      - name: Generate ASCII Table
        id: generate_table
        shell: pwsh
        env:
          ISSUE_COUNTS: ${{ needs.count_issues.outputs.issue_counts }}
        run: |
          $issueCounts = $env:ISSUE_COUNTS | ConvertFrom-Json
          $table = "Column | Assignee | Count`n"
          $table += "-------|----------|------`n"
          foreach ($column in $issueCounts.Keys) {
            foreach ($assignee in $issueCounts[$column].Keys) {
              $table += "$column | $assignee | $($issueCounts[$column][$assignee])`n"
            }
          }
          Write-Host "ASCII Table:`n$table"